<!DOCTYPE html>
<html>

<head>
    <!-- Plotly graph library -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>

    </style>
</head>

<body>
    <!-- Source: https://weatherwidget.io/ -->
    <div id="weather">
            <a class="weatherwidget-io" href="https://forecast7.com/en/n40d15175d49/halcombe/" data-label_1="REUREU VALLEY" data-label_2="WEATHER" data-font="Roboto" data-icons="Climacons Animated" data-theme="original" data-basecolor="" >REUREU VALLEY WEATHER</a>
            <script>
            !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src='https://weatherwidget.io/js/widget.min.js';fjs.parentNode.insertBefore(js,fjs);}}(document,'script','weatherwidget-io-js');
            </script>
    </div>

    <div id="map"></div>
    <script>
        //create google map
        var map;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 15.5,
                center: new google.maps.LatLng(-40.081, 175.475),
                mapTypeId: 'satellite',
                disableDefaultUI: true
            });

            //Get device data from Cloudant, convert to geoJson

            //Cloudant creds 
            //user:sonespectiestrivainstrai
            //pass:c5dfc1f500aad59873ddb67a14520fcbb24c02cf
            //var encodedData = window.btoa('sonespectiestrivainstrai:c5dfc1f500aad59873ddb67a14520fcbb24c02cf')
            //as base64: c29uZXNwZWN0aWVzdHJpdmFpbnN0cmFpOmM1ZGZjMWY1MDBhYWQ1OTg3M2RkYjY3YTE0NTIwZmNiYjI0YzAyY2Y=
            const devicesUrl =
                'https://0d664ca0-3c79-4620-a429-b55e8512d0c5-bluemix.cloudant.com/devices/_all_docs?include_docs=true'

            const optionsDevice = {
                "method": "GET",
                "crossDomain": true,
                "headers": {
                    "Authorization": "Basic c29uZXNwZWN0aWVzdHJpdmFpbnN0cmFpOmM1ZGZjMWY1MDBhYWQ1OTg3M2RkYjY3YTE0NTIwZmNiYjI0YzAyY2Y="
                }
            }

            let geoJsonData = undefined;

            //DEVICES!!
            const deviceGeoJsonPromise = new Promise((resolve) => {
                let geojson = {};
                geojson['type'] = 'FeatureCollection';
                geojson['features'] = [];

                fetch(devicesUrl, optionsDevice)
                    .then(res => res.json())
                    .then(data => {
                        //create geojson: //create geojson loop. source: https://gist.github.com/mapsam/7320ccb2aba0ac372050
                        for (const device in data.rows) {
                            const newFeature = {
                                "type": "Feature",
                                "geometry": {
                                    "type": "Point",
                                    "coordinates": [parseFloat(data.rows[device].doc.location[1]),
                                        parseFloat(data.rows[device].doc.location[0])
                                    ]
                                },
                                "properties": {
                                    "title": data.rows[device].doc.name,
                                    "description": data.rows[device].doc.description
                                }
                            }
                            geojson['features'].push(newFeature);
                        }
                        resolve(geojson)
                    })
                    .catch(err => console.log('Error: ', err))
            })


//=================*** DATA!! ***=============================

            const dataUrl =
                // 'https://0d664ca0-3c79-4620-a429-b55e8512d0c5-bluemix.cloudant.com/device_data/_all_docs?include_docs=true&descending=true&limit=1000'
                'https://0d664ca0-3c79-4620-a429-b55e8512d0c5-bluemix.cloudant.com/device_data/_find'
            
            const optionsData = {
                "method": "POST",
                "crossDomain": true,
                "headers": {
                    "Authorization": "Basic c29uZXNwZWN0aWVzdHJpdmFpbnN0cmFpOmM1ZGZjMWY1MDBhYWQ1OTg3M2RkYjY3YTE0NTIwZmNiYjI0YzAyY2Y=",
                    "content-type": "application/json"
                },
                "body": JSON.stringify({
                    "selector": {
                        "created": {
                            "$gte": 0
                        }
                    },
                    "fields": [
                        "_id",
                        "device_physical_id",
                        "device_name",
                        "temperature",
                        "humidity",
                        "created"
                    ],
                    "sort": [
                        {
                            "created": "desc"
                        }
                    ],
                    "limit": 100
                    })
            }


            const deviceDataPromise = new Promise((resolve) => {
                fetch(dataUrl, optionsData)
                    .then(res => res.json())
                    .then(data => {
                        resolve(data)
                    })
                    .catch(err => console.log('Error: ', err))
            })

            deviceGeoJsonPromise.then(data => {
                geoJsonData = data
                return deviceDataPromise
            }).then(deviceData => {
                console.log("got geojson?")
                console.log(geoJsonData)
                console.log("got data?")
                console.log(deviceData)
            
/*===========***   Currently not doing anything with deviceData.  ***
             ***   Now getting data on marker click??!!           ***=================*/


                //loop each device
                // for (var i = 0; i < deviceData.docs.length; i++) {
                for (var i = 0; i < geoJsonData.features.length; i++) {
                    
                    //get device latlng coordinates for marker
                    var coords = geoJsonData.features[i].geometry.coordinates;
                    var latLng = new google.maps.LatLng(coords[1], coords[0]);
                    var deviceName = geoJsonData.features[i].properties.title

                    //return the last device reading. (will only find if is in the last 100 queried)
                    var thisDevice = isDeviceLive(deviceName, deviceData.docs);
                    
                    createMarkerForDevice(latLng, deviceName, thisDevice.markerColour, thisDevice.lastTemp, thisDevice.lastHum)
                } 
                //end of for loop (that creates the markers)

            })

            //Close open infowindows when map is clicked
            map.addListener("click", function(event) {
                closeAllInfoWindows(map);
            });


        } //-------- End initMap()

        var markers = [];

        function createMarkerForDevice(latLng, name, colour, lastTemp, lastHum) {

            let content = `
                <div class="deviceDataWindow">
                        <div class="deviceDataLabel" id="tempLabel">Temperature</div>
                        <div class="deviceDataReading" id="tempValue"><sup>Â°C</sup></div>

                        <div class="deviceDataLabel" id="humLabel">Humidity</div>
                        <div class="deviceDataReading" id="humValue"><sup>%</sup></div>

                        <div class="deviceDataLabel" id="deviceLabel">Device Name</div>
                        <div class="deviceDataValue" id="deviceValue"></div>

                        <div class="deviceDataLabel" id="timeLabel">Last Activity</div>
                        <div class="deviceDataValue" id="timeValue"></div>

                        <div class="deviceDataLabel" id="tempHistoryLabel">Temp History</div>
                        <div class="graph deviceDataLabel" id="tempGraph"></div>

                        <div class="deviceDataLabel" id="humHistoryLabel">Hum History</div>
                        <div class="graph deviceDataLabel" id="humGraph"></div>
                </div>
            `
            
            //create infowindow
            var infowindowData = new google.maps.InfoWindow({
                content: content
            });

            //create marker with infowindow
            var marker = new google.maps.Marker({
                position: latLng,
                map: map,
                label: lastTemp, //label on marker
                infowindow: infowindowData
            });

            markers.push(marker);

            //add infoWindow Event
            marker.addListener('click', function () {
                //hide open info windows
                closeAllInfoWindows(map);
                //open new infowindow
                this.infowindow.open(map, marker);

                //add marker click event (zoom, and pan)
                map.setZoom(17);
                map.setCenter(marker.getPosition());
                map.panBy(0, -200);

                //update device data
                
                populateGraph(name)
            });

        } //end createMarkerForDevice()

        // Hide all markers function
        function closeAllInfoWindows(map) {
            markers.forEach(function(marker) {
                marker.infowindow.close(map, marker);
            }); 
        }

function populateGraph(deviceName) {

    const dataUrl =
    'https://0d664ca0-3c79-4620-a429-b55e8512d0c5-bluemix.cloudant.com/device_data/_find'

    const optionsSingleDevice = {
        "method": "POST",
        "crossDomain": true,
        "headers": {
            "Authorization": "Basic c29uZXNwZWN0aWVzdHJpdmFpbnN0cmFpOmM1ZGZjMWY1MDBhYWQ1OTg3M2RkYjY3YTE0NTIwZmNiYjI0YzAyY2Y=",
            "content-type": "application/json"
        },
        "body": JSON.stringify({
            "selector": {
                "device_name": {
                    "$eq": deviceName
                }
            },
            "fields": [
                "_id",
                "device_name",
                "temperature",
                "humidity",
                "created"
            ],
            "sort": [
                {
                    "created": "desc"  //get the most recent records for this device
                }
            ],
            "limit": 10 //limit this to the 10 most recent records
        })
    }

    //get single device data
    const singleDeviceDataPromise = new Promise((resolve) => {
        fetch(dataUrl, optionsSingleDevice)
            .then(res => res.json())
            .then(dataSingle => {
                // resolve(data)
                console.log('single device data')
                console.log(dataSingle)

                //create temp and hum objects for chart data
                //Temperature
                let temp = {
                    x: [],
                    y: [],
                    text: [],
                    textposition: 'top center',
                    textfont: {
                        size: 9
                    },
                    mode: 'lines+text',
                    type: 'scatter',
                    name: 'temp',
                    line: {
                        color: 'rgb(253, 180, 75)',
                    },
                    hoverinfo: 'x+y'
                    // marker: { size: 12 }
                }

                //Humidity
                let hum = {
                    x: [],
                    y: [],
                    text: [],
                    textposition: 'top center',
                    textfont: {
                        size: 9
                    },
                    mode: 'lines+text',
                    // textposition: 'top center',
                    type: 'scatter',
                    name: 'hum',
                    line: {
                        color: 'rgb(0, 187, 240)'
                    },
                    hoverinfo: 'x+y'
                }

                //loop data to plot onto graph
                for (const each in dataSingle.docs) {               
                    //convert UTC packet created time to NZ time
                    let time = new Date(dataSingle.docs[each].created)
                    temp.x.push(time)
                    temp.y.push(dataSingle.docs[each].temperature)
                    temp.text.push(dataSingle.docs[each].temperature)
                    hum.x.push(time)
                    hum.y.push(dataSingle.docs[each].humidity)
                    hum.text.push(dataSingle.docs[each].humidity)
                }

                // console.log(temp)

                //reverse arrays so the last 10 records are in ascending order.
                temp.x.reverse()
                temp.y.reverse()
                temp.text.reverse()
                hum.x.reverse()
                hum.y.reverse()
                hum.text.reverse()

                //chart data
                const tempChartData = [temp]
                const humChartData = [hum]
                
                //chart layout
                let layout = {
                    // title: 'Temperature & Humidity',
                    autosize: true,
                    showlegend: false,
                    legend: {
                        // "orientation": "h", 
                        x: 0, 
                        y: 100
                    },
                    margin: {
                        t: 10,
                        b: 60,
                        l: 10,
                        r: 10,
                        pad: 0
                        },
                    xaxis: {
                        // title: 'AXIS TITLE',
                        // titlefont{},
                        tickangle: 45,
                        tickfont: {
                            family: 'Arial, sans-serif',
                            size: 9,
                            color: 'black'
                        },
                        showgrid: false,
                    },
                    yaxis: {
                        // title: 'AXIS TITLE',
                        tickangle: 0,
                        tickfont: {
                            family: 'Arial, sans-serif',
                            size: 9,
                            color: 'black'
                        },
                        showgrid: false,
                        showticklabels: false
                    }
                }

                //update infowindow values for single device

                //DEVICE NAME
                document.getElementById('deviceValue').innerHTML = dataSingle.docs[0].device_name
                //LAST ACTIVITY
                let time = new Date(dataSingle.docs[0].created).toString()
                document.getElementById('timeValue').innerHTML = time
                //TEMPERATURE
                let roundedTemp = Math.round(dataSingle.docs[0].temperature * 10) / 10
                document.getElementById('tempValue').innerHTML =  roundedTemp.toFixed(1)+ '<sup>Â°C</sup>'
                //HUMIDITY
                document.getElementById('humValue').innerHTML = dataSingle.docs[0].humidity + '<sup>%</sup>'
                

                //load graphs
                Plotly.newPlot('tempGraph', tempChartData, layout, {displayModeBar: false});
                Plotly.newPlot('humGraph', humChartData, layout, {displayModeBar: false});

            })
            .catch(err => console.log('Error: ', err))
    })

}     

function isDeviceLive(nameKey, myArray){
    //loop all docs. see if nameKey is in docs. if it is make green. if not make grey.
    for (var i=0; i < myArray.length; i++) {
        if (myArray[i].device_name === nameKey) {
            // return this if device WAS present
            return {
                markerColour: 'green',
                lastTemp: myArray[i].temperature,
                lastHum: myArray[i].humidity,
            }
        } else {
            // return this if device was NOT present
            return {
                markerColour: 'grey',
                lastTemp: 'offline',
                lastHum: 'offline',
            }
        }
    }
    return 'device not found in last 100 queried'
}

    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCA4KEFZfbeZhUwtpYfm-__hkTrIuwfyPs&callback=initMap">
    </script>
</body>

</html>